# Zoe - Container-based Analytics as a Service

This service uses Docker Swarm to run on-demand analytics clusters. Currently, only Apache Spark is supported.

Zoe is composed of three components:

* zoectl: command-line client
* zoe-scheduler: the main daemon that performs application scheduling and talks to Swarm
* zoe-web: the web service

## Requirements

* MySQL to keep all the state
* Docker Swarm
* A Docker registry containing Spark images
* Apache Web Server to act as a reverse proxy

## Configuration

Zoe configuration is read from an 'ini' file, the following locations are searched for file names `zoe.conf`:
* working path (.)
* /etc/zoe

A sample configuration file, containing default values for all options can be generated by running `zoectl.py write-conf zoe.conf`

### Swarm/Docker

For testing purposes, you can use a single Docker instance, by setting its endpoint in the configuration file mentioned above.

To use Swarm, we use an undocumented network configuration, with the docker bridges connected to a physical interface, so that
containers on different hosts can talk to each other on the same layer 2 domain.

### Images: Docker Hub Vs local Docker registry

The images used by Zoe are available on the Docker Hub:

* https://hub.docker.com/r/zoerepo/spark-scala-notebook/
* https://hub.docker.com/r/zoerepo/spark-master/
* https://hub.docker.com/r/zoerepo/spark-worker/
* https://hub.docker.com/r/zoerepo/spark-submit/

Since the Docker Hub can be quite slow, we strongly suggest setting up a private registry. The `build_images.sh` script in the
[zoe-docker-images](https://github.com/DistributedSystemsGroup/zoe-docker-images) repository can help you populate the registry
bypassing the Hub.

The images are quite standard and can be used also without Zoe. Examples on how to do that, are available in the `scripts/start_cluster.sh` script.

### Apache Web Server configuration

Zoe dynamically generates proxy entries to let users access the various web interfaces available for Apache Spark.
To do this, it needs to be able to reload the server and write to a configuration file included in the VirtualHost directive.

Here is an example configuration for a virtual host:
```
ProxyHTMLLinks a href
ProxyHTMLLinks area href
ProxyHTMLLinks link href
ProxyHTMLLinks img src longdesc usemap
ProxyHTMLLinks object classid codebase data usemap
ProxyHTMLLinks q cite
ProxyHTMLLinks blockquote cite
ProxyHTMLLinks ins cite
ProxyHTMLLinks del cite
ProxyHTMLLinks form action
ProxyHTMLLinks input src usemap
ProxyHTMLLinks head profile
ProxyHTMLLinks base href
ProxyHTMLLinks script src for

ProxyHTMLEvents onclick ondblclick onmousedown onmouseup \
    onmouseover onmousemove onmouseout onkeypress \
    onkeydown onkeyup onfocus onblur onload \
    onunload onsubmit onreset onselect onchange

ProxyRequests Off

<Location />
        ProxyHtmlEnable On
        ProxyHTMLExtended On
        ProxyPass http://127.0.0.1:5000/ retry=0
        ProxyPassReverse http://127.0.0.1:5000/
</Location>

IncludeOptional /tmp/zoe-proxy.conf*
```

This configuration will also proxy zoe-web, that starts on port 5000 by default.

Please note that putting the generated config file in /tmp can be a serious security problem, depending on your setup.
